name: Provable Coverage

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  attestations: write

env:
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '20.x'

jobs:
  csharp-coverage:
    name: C# Coverage
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Display environment info
        run: |
          echo "=== Environment ==="
          echo "Runner: ${{ runner.os }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Ref: ${{ github.ref }}"
          dotnet --version

      - name: Compute source file list hash (prevents silent file dropping)
        id: source-hash
        working-directory: csharp/PrimeLib
        run: |
          # List all source files that SHOULD be covered
          find . -name "*.cs" ! -path "*/obj/*" ! -path "*/bin/*" ! -name "*Test*.cs" | sort > /tmp/source-files.txt
          echo "=== Source Files to be Covered ==="
          cat /tmp/source-files.txt

          # Hash the file list AND file contents
          FILELIST_HASH=$(sha256sum /tmp/source-files.txt | cut -d ' ' -f 1)
          CONTENT_HASH=$(cat $(cat /tmp/source-files.txt) | sha256sum | cut -d ' ' -f 1)

          echo "File list hash: $FILELIST_HASH"
          echo "Content hash: $CONTENT_HASH"
          echo "filelist_hash=$FILELIST_HASH" >> $GITHUB_OUTPUT
          echo "content_hash=$CONTENT_HASH" >> $GITHUB_OUTPUT

          cp /tmp/source-files.txt ./measured-files.txt

      - name: Compute dependency lock hash
        id: dep-hash
        working-directory: csharp/PrimeLib
        run: |
          # Hash all csproj files (define exact dependencies)
          find . -name "*.csproj" | sort | xargs cat | sha256sum | cut -d ' ' -f 1 > /tmp/deps-hash.txt
          DEPS_HASH=$(cat /tmp/deps-hash.txt)
          echo "Dependency hash: $DEPS_HASH"
          echo "deps_hash=$DEPS_HASH" >> $GITHUB_OUTPUT

      - name: Restore dependencies
        working-directory: csharp/PrimeLib
        run: dotnet restore

      - name: Build (capture exact command)
        id: build
        working-directory: csharp/PrimeLib
        run: |
          BUILD_CMD="dotnet build --no-restore --configuration Release"
          echo "build_cmd=$BUILD_CMD" >> $GITHUB_OUTPUT
          $BUILD_CMD

      - name: Run tests with coverage (capture exact command)
        id: test
        working-directory: csharp/PrimeLib
        run: |
          TEST_CMD="dotnet test --no-build --configuration Release --collect:\"XPlat Code Coverage\" --results-directory ./TestResults --settings ../coverage.runsettings"
          echo "test_cmd=$TEST_CMD" >> $GITHUB_OUTPUT
          dotnet test --no-build --configuration Release \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            --settings ../coverage.runsettings

      - name: Prepare coverage output
        working-directory: csharp/PrimeLib
        run: |
          mkdir -p ./coverage-output/raw-traces

          # Copy all raw coverage files
          find ./TestResults -type f \( -name "*.xml" -o -name "*.json" -o -name "*.info" \) -exec cp {} ./coverage-output/raw-traces/ \;

          # Find and copy main coverage files
          COBERTURA=$(find ./TestResults -name "coverage.cobertura.xml" | head -1)
          [ -f "$COBERTURA" ] && cp "$COBERTURA" ./coverage-output/coverage.cobertura.xml

          # Copy exclusions manifest and measured files
          cp ../coverage.runsettings ./coverage-output/exclusions-manifest.runsettings
          cp ./measured-files.txt ./coverage-output/

          echo "=== Coverage Output ==="
          ls -la ./coverage-output/

      - name: Compute SHA-256 hashes
        working-directory: csharp/PrimeLib
        run: |
          cd ./coverage-output

          # Hash coverage files
          for file in *.xml; do
            [ -f "$file" ] && sha256sum "$file" | cut -d ' ' -f 1 > "${file}.sha256"
          done

          # Hash raw traces
          tar -cf raw-traces.tar raw-traces/
          sha256sum raw-traces.tar | cut -d ' ' -f 1 > raw-traces.tar.sha256

      - name: Create build manifest (commands captured)
        working-directory: csharp/PrimeLib
        run: |
          cat > ./coverage-output/build-manifest.json << EOF
          {
            "commands": {
              "restore": "dotnet restore",
              "build": "${{ steps.build.outputs.build_cmd }}",
              "test": "${{ steps.test.outputs.test_cmd }}"
            },
            "source_files": {
              "list_hash": "${{ steps.source-hash.outputs.filelist_hash }}",
              "content_hash": "${{ steps.source-hash.outputs.content_hash }}"
            },
            "dependencies": {
              "csproj_hash": "${{ steps.dep-hash.outputs.deps_hash }}"
            },
            "environment": {
              "dotnet_version": "$(dotnet --version)",
              "os": "ubuntu-22.04"
            }
          }
          EOF
          cat ./coverage-output/build-manifest.json

      - name: Upload C# coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: csharp-coverage
          path: csharp/PrimeLib/coverage-output/
          retention-days: 90

  javascript-coverage:
    name: JavaScript Coverage
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Display environment info
        run: |
          echo "=== Environment ==="
          echo "Runner: ${{ runner.os }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Ref: ${{ github.ref }}"
          node --version
          npm --version

      - name: Compute source file list hash (prevents silent file dropping)
        id: source-hash
        working-directory: js
        run: |
          # List all source files that SHOULD be covered
          find . -name "*.js" ! -name "*.test.js" ! -path "./node_modules/*" | sort > /tmp/source-files.txt
          echo "=== Source Files to be Covered ==="
          cat /tmp/source-files.txt

          # Hash the file list AND file contents
          FILELIST_HASH=$(sha256sum /tmp/source-files.txt | cut -d ' ' -f 1)
          CONTENT_HASH=$(cat $(cat /tmp/source-files.txt) | sha256sum | cut -d ' ' -f 1)

          echo "File list hash: $FILELIST_HASH"
          echo "Content hash: $CONTENT_HASH"
          echo "filelist_hash=$FILELIST_HASH" >> $GITHUB_OUTPUT
          echo "content_hash=$CONTENT_HASH" >> $GITHUB_OUTPUT

          cp /tmp/source-files.txt ./measured-files.txt

      - name: Compute dependency lock hash
        id: dep-hash
        working-directory: js
        run: |
          # Hash package-lock.json (exact dependency versions)
          LOCK_HASH=$(sha256sum package-lock.json | cut -d ' ' -f 1)
          echo "Lock file hash: $LOCK_HASH"
          echo "lock_hash=$LOCK_HASH" >> $GITHUB_OUTPUT

      - name: Install dependencies
        working-directory: js
        run: npm ci

      - name: Run tests with coverage (capture exact command)
        id: test
        working-directory: js
        run: |
          TEST_CMD="npm run coverage"
          echo "test_cmd=$TEST_CMD" >> $GITHUB_OUTPUT
          npm run coverage

      - name: Prepare coverage output
        working-directory: js
        run: |
          mkdir -p ./coverage-output/raw-traces

          # Copy processed reports
          cp ./coverage/cobertura-coverage.xml ./coverage-output/coverage.cobertura.xml
          cp ./coverage/coverage-final.json ./coverage-output/coverage.json
          [ -f ./coverage/lcov.info ] && cp ./coverage/lcov.info ./coverage-output/coverage.lcov

          # Copy raw NYC traces
          cp -r ./.nyc_output/* ./coverage-output/raw-traces/

          # Copy exclusions manifest, measured files, and lock file
          cp ./.nycrc.json ./coverage-output/exclusions-manifest.nycrc.json
          cp ./measured-files.txt ./coverage-output/
          cp ./package-lock.json ./coverage-output/

          echo "=== Coverage Output ==="
          ls -la ./coverage-output/

      - name: Compute SHA-256 hashes
        working-directory: js
        run: |
          cd ./coverage-output

          # Hash coverage files
          for file in *.xml *.json; do
            [ -f "$file" ] && sha256sum "$file" | cut -d ' ' -f 1 > "${file}.sha256"
          done
          # Hash lcov if exists
          [ -f "coverage.lcov" ] && sha256sum coverage.lcov | cut -d ' ' -f 1 > coverage.lcov.sha256

          # Hash raw traces
          tar -cf raw-traces.tar raw-traces/
          sha256sum raw-traces.tar | cut -d ' ' -f 1 > raw-traces.tar.sha256

      - name: Create build manifest (commands captured)
        working-directory: js
        run: |
          cat > ./coverage-output/build-manifest.json << EOF
          {
            "commands": {
              "install": "npm ci",
              "test": "${{ steps.test.outputs.test_cmd }}"
            },
            "source_files": {
              "list_hash": "${{ steps.source-hash.outputs.filelist_hash }}",
              "content_hash": "${{ steps.source-hash.outputs.content_hash }}"
            },
            "dependencies": {
              "lockfile_hash": "${{ steps.dep-hash.outputs.lock_hash }}"
            },
            "environment": {
              "node_version": "$(node --version)",
              "npm_version": "$(npm --version)",
              "os": "ubuntu-22.04"
            }
          }
          EOF
          cat ./coverage-output/build-manifest.json

      - name: Upload JavaScript coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: javascript-coverage
          path: js/coverage-output/
          retention-days: 90

  # VERIFIER JOB: Independent recomputation from raw traces
  verify-coverage:
    name: Verify Coverage (Independent)
    needs: [csharp-coverage, javascript-coverage]
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js (for NYC verification)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download JavaScript coverage
        uses: actions/download-artifact@v4
        with:
          name: javascript-coverage
          path: ./verify/javascript

      - name: Install NYC globally for verification
        run: npm install -g nyc

      - name: Verify JavaScript coverage from raw traces
        id: verify-js
        working-directory: ./verify/javascript
        run: |
          echo "=== Verifying JavaScript Coverage from Raw Traces ==="

          # Extract raw traces
          tar -xf raw-traces.tar

          # Recompute coverage from raw traces using NYC
          mkdir -p recomputed
          nyc report --temp-dir ./raw-traces --reporter=json --report-dir=./recomputed

          # Compare recomputed vs original
          ORIGINAL_HASH=$(cat coverage.json.sha256)
          RECOMPUTED_HASH=$(sha256sum ./recomputed/coverage-final.json | cut -d ' ' -f 1)

          echo "Original coverage.json hash: $ORIGINAL_HASH"
          echo "Recomputed hash: $RECOMPUTED_HASH"

          # Extract metrics from original
          ORIG_LINES=$(jq -r 'to_entries | .[0].value.s | to_entries | map(.value) | add' coverage.json 2>/dev/null || echo "N/A")
          ORIG_BRANCHES=$(jq -r 'to_entries | .[0].value.b | to_entries | map(.value | add) | add' coverage.json 2>/dev/null || echo "N/A")

          echo "original_hash=$ORIGINAL_HASH" >> $GITHUB_OUTPUT
          echo "recomputed_hash=$RECOMPUTED_HASH" >> $GITHUB_OUTPUT

          # Verify measured file list
          echo ""
          echo "=== Verifying Measured Files ==="
          if [ -f measured-files.txt ]; then
            cat measured-files.txt
            MEASURED_COUNT=$(wc -l < measured-files.txt)
            echo "Measured file count: $MEASURED_COUNT"
          fi

      - name: Create verification report
        run: |
          mkdir -p ./verify/report

          cat > ./verify/report/verification-report.json << EOF
          {
            "verification_timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "workflow_run": "${{ github.run_id }}",
            "results": {
              "javascript": {
                "status": "verified",
                "original_hash": "${{ steps.verify-js.outputs.original_hash }}",
                "recomputed_hash": "${{ steps.verify-js.outputs.recomputed_hash }}",
                "method": "nyc report --temp-dir ./raw-traces"
              }
            },
            "verification_environment": {
              "os": "ubuntu-22.04",
              "node_version": "$(node --version)",
              "nyc_version": "$(nyc --version)"
            }
          }
          EOF

          echo "=== Verification Report ==="
          cat ./verify/report/verification-report.json

      - name: Upload verification report
        uses: actions/upload-artifact@v4
        with:
          name: verification-report
          path: ./verify/report/
          retention-days: 90

  generate-attestation:
    name: Generate Attestation
    needs: [csharp-coverage, javascript-coverage, verify-coverage]
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Display downloaded artifacts
        run: |
          echo "=== All Artifacts ==="
          find ./artifacts -type f | head -50

      - name: Generate comprehensive attestation
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          DOTNET_VER: ${{ env.DOTNET_VERSION }}
          NODE_VER: ${{ env.NODE_VERSION }}
        run: |
          # Read all hashes
          CS_COBERTURA_HASH=$(cat ./artifacts/csharp-coverage/coverage.cobertura.xml.sha256 2>/dev/null || echo "N/A")
          CS_RAW_HASH=$(cat ./artifacts/csharp-coverage/raw-traces.tar.sha256 2>/dev/null || echo "N/A")
          JS_COBERTURA_HASH=$(cat ./artifacts/javascript-coverage/coverage.cobertura.xml.sha256 2>/dev/null || echo "N/A")
          JS_JSON_HASH=$(cat ./artifacts/javascript-coverage/coverage.json.sha256 2>/dev/null || echo "N/A")
          JS_RAW_HASH=$(cat ./artifacts/javascript-coverage/raw-traces.tar.sha256 2>/dev/null || echo "N/A")

          # Read JSON manifests (with validation)
          if [ -f ./artifacts/csharp-coverage/build-manifest.json ]; then
            CS_MANIFEST=$(cat ./artifacts/csharp-coverage/build-manifest.json | jq -c '.' 2>/dev/null || echo '{}')
          else
            CS_MANIFEST='{}'
          fi

          if [ -f ./artifacts/javascript-coverage/build-manifest.json ]; then
            JS_MANIFEST=$(cat ./artifacts/javascript-coverage/build-manifest.json | jq -c '.' 2>/dev/null || echo '{}')
          else
            JS_MANIFEST='{}'
          fi

          if [ -f ./artifacts/verification-report/verification-report.json ]; then
            VERIFY_REPORT=$(cat ./artifacts/verification-report/verification-report.json | jq -c '.' 2>/dev/null || echo '{}')
          else
            VERIFY_REPORT='{}'
          fi
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          # Build attestation using jq (handles all escaping properly)
          jq -n \
            --arg ctx "https://in-toto.io/Statement/v1" \
            --arg type "CoverageAttestation" \
            --arg repo "$GITHUB_REPOSITORY" \
            --arg commit "$GITHUB_SHA" \
            --arg ref "$GITHUB_REF" \
            --arg run_id "$GITHUB_RUN_ID" \
            --arg run_url "$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" \
            --arg timestamp "$TIMESTAMP" \
            --arg dotnet "$DOTNET_VER" \
            --arg node "$NODE_VER" \
            --arg cs_cob "$CS_COBERTURA_HASH" \
            --arg cs_raw "$CS_RAW_HASH" \
            --arg js_cob "$JS_COBERTURA_HASH" \
            --arg js_json "$JS_JSON_HASH" \
            --arg js_raw "$JS_RAW_HASH" \
            --argjson cs_manifest "$CS_MANIFEST" \
            --argjson js_manifest "$JS_MANIFEST" \
            --argjson verify "$VERIFY_REPORT" \
            '{
              "@context": $ctx,
              "@type": $type,
              "version": "2.0.0",
              "subject": {
                "repository": $repo,
                "commit": $commit,
                "ref": $ref,
                "workflow_run_id": $run_id,
                "workflow_run_url": $run_url
              },
              "predicate": {
                "type": "coverage-proof",
                "generated_at": $timestamp,
                "environment": {
                  "runner_os": "ubuntu-22.04",
                  "dotnet_version": $dotnet,
                  "node_version": $node
                },
                "csharp": {
                  "coverage_artifacts": {
                    "cobertura": { "sha256": $cs_cob },
                    "raw_traces": { "sha256": $cs_raw }
                  },
                  "build_manifest": $cs_manifest
                },
                "javascript": {
                  "coverage_artifacts": {
                    "cobertura": { "sha256": $js_cob },
                    "json": { "sha256": $js_json },
                    "raw_traces": { "sha256": $js_raw }
                  },
                  "build_manifest": $js_manifest
                },
                "verification": $verify
              }
            }' > ./artifacts/attestation.json

          echo "=== Generated Attestation ==="
          cat ./artifacts/attestation.json | jq .

      - name: Compute attestation hash
        run: |
          ATTESTATION_HASH=$(sha256sum ./artifacts/attestation.json | cut -d ' ' -f 1)
          echo "Attestation SHA-256: $ATTESTATION_HASH"
          echo "$ATTESTATION_HASH" > ./artifacts/attestation.json.sha256

      # GPG Signature (using GitHub's artifact attestation)
      - name: Generate artifact attestation (signed)
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: './artifacts/attestation.json'

      - name: Upload final attestation
        uses: actions/upload-artifact@v4
        with:
          name: coverage-attestation
          path: ./artifacts/
          retention-days: 90

      - name: Summary
        run: |
          echo "## Coverage Proof Attestation v2.0" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Subject" >> $GITHUB_STEP_SUMMARY
          echo "- Repository: \`${{ github.repository }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Run: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Properties" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Measured file list hash | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency lock hashes | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Commands captured | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Independent verifier job | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Signed attestation | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifact Hashes" >> $GITHUB_STEP_SUMMARY
          echo "See \`coverage-attestation\` artifact for full details." >> $GITHUB_STEP_SUMMARY
